# AOP

Aspect Oriented Programming

对于操作字节码的方式来说，一般都在 **代码监控、代码修改、代码分析** 这三个场景有着很广泛的应用。



相对于 `Java` 代码生成的方式，操作字节码的方式有如下 **特点**：

- 1）、**应用场景更广**。
- 2）、**功能更加强大**。
- 3）、**使用复杂度较高**。

此外，我们不仅可以操作 `.class` 文件的 `Java` 字节码，也可以操作 `.dex` 文件的 `Dalvik` 字节码。下面我们就来大致了解下在以上三类场景中编译插桩技术具体是如何应用的。



# AspectJ



最常用的字节码处理框架有 `AspectJ、ASM` 等等，它们的相同之处在于输入输出都是 `Class` 文件。并且，它们都是 **在 Java 文件编译成 .class 文件之后，生成 Dalvik 字节码之前执行**。

而 **AspectJ 作为 Java 中流行的 AOP（aspect-oriented programming） 编程扩展框架，其内部使用的是 [BCEL框架](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fapache%2Fcommons-bcel) 来完成其功能**。下面，我们就来了解下 `AspectJ` 具备哪些优势。



## 优势

### 1、成熟稳定

字节码的处理并不简单，特别是 **针对于字节码的格式和各种指令规则**，如果处理出错，就会导致程序编译或者运行过程中出现问题。而 `AspectJ` 作为从 2001 年发展至今的框架，它已经发展地非常成熟，通常不用考虑插入的字节码发生正确性相关的问题。

### 2、使用非常简单

`AspectJ` 的使用非常简单，并且它的功能非常强大，我们完全不需要理解任何 `Java` 字节码相关的知识，就可以在很多情况下对字节码进行操控。例如，它可以在如下五个位置插入自定义的代码：

- 1）、**在方法（包括构造方法）被调用的位置**。
- 2）、**在方法体（包括构造方法）的内部**。
- 3）、**在读写变量的位置**。
- 4）、**在静态代码块内部**。
- 5）、**在异常处理的位置的前后**。

此外，它也可以 **直接将原位置的代码替换为自定义的代码**。




## 劣势

### 1、切入点固定

**AspectJ 只能在一些固定的切入点来进行操作**，如果想要进行更细致的操作则很难实现，它无法针对一些特定规则的字节码序列做操作。

### 2、正则表达式的局限性

`AspectJ` 的匹配规则采用了类似正则表达式的规则，比如 **匹配 Activity 生命周期的 onXXX 方法，如果有自定义的其他以 on 开头的方法也会匹配到，这样匹配的正确性就无法满足**。

### 3、性能较低

`AspectJ` 在实现时会包装自己一些特定的类，它并不会直接把 `Trace` 函数直接插入到代码中，而是经过一系列自己的封装。这样不仅生成的字节码比较大，而且对原函数的性能会有不小的影响。**如果想对 App 中所有的函数都进行插桩，性能影响肯定会比较大。如果你只插桩一小部分函数，那么 AspectJ 带来的性能损耗几乎可以忽略不计**。


